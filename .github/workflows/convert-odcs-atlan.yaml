name: ODCS contracts using Atlan CLI

on:
  workflow_call:
    inputs:
      caller-repo:
        description: "Full repo name of caller (owner/repo)"
        required: true
        type: string
      input-path:
        description: "Path to ODCS YAML relative to caller repo root"
        required: true
        type: string
      caller-ref:
        description: "Git ref of caller repo"
        required: false
        type: string
    secrets:
      CALLER_REPO_TOKEN:
        description: "Read-only token for caller repo"
        required: true

env:
  ATLAN_BINARY_URL: "https://github.com/atlanhq/atlan-cli-releases/releases/latest/download/atlan_Linux_amd64.tar.gz"
  BINARY_FILE_NAME: "atlan_Linux_amd64.tar.gz"

jobs:
  publish-contracts:
    runs-on: ubuntu-latest

    steps:      
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.caller-repo }}
          ref: ${{ inputs.caller-ref || github.ref }}
          token: ${{ secrets.CALLER_REPO_TOKEN }}
          path: caller-repo
          sparse-checkout: |
            ${{ inputs.input-path }}
      - name: Checkout validation repo
        uses: actions/checkout@v4
        with:
          repository: ashwinkumarkondath/data-contracts-repo
          path: data-contracts-repo

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install converter dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Download atlan CLI
        run: |
          curl -LO "$ATLAN_BINARY_URL"

      - name: Uncompress CLI archive
        run: tar -xzf "$BINARY_FILE_NAME"

      - name: Install atlan CLI
        run: |
          sudo mv atlan /usr/local/bin/atlan
          chmod +x /usr/local/bin/atlan
          
      - name: Execute the script
        working-directory: data-contracts-repo
        run: |
          python scripts/convert-odcs-atlan.py\
            ../caller-repo/${{ inputs.input-path }}
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}
          OUTPUT_DIR: data_contracts/
          CONFIG_FILE: config.yaml

      - name: Configure CLI with tenant URL and data source
        working-directory: data-contracts-repo
        run: |
          mkdir -p .atlan
          cp $CONFIG_FILE .atlan/config.yaml
          echo "atlan_base_url: \"${ATLAN_BASE_URL}\"" >> .atlan/config.yaml
          echo "" >> .atlan/config.yaml
          cat .atlan/config.yaml
        env:
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}

      - name: Validate contracts (CLI)
        working-directory: data-contracts-repo
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          # Run validation and capture output to a timestamped log file
          cat "data_contracts/"*.yaml
          atlan validate contract -f "data_contracts" 2>&1 | tee "validation_log_${TIMESTAMP}.txt"
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}

      - name: Upload validation log
        uses: actions/upload-artifact@v4
        with:
          working-directory: data-contracts-repo
          name: validation-logs
          path: validation_log_*.txt 

      - name: Push contracts to Atlan (draft)
        working-directory: data-contracts-repo
        run: |
          atlan push contract -f "data_contracts/"
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}

      - name: Publish contracts to Atlan
        working-directory: data-contracts-repo
        run: |
          # Update status from draft to verified before publishing
          find "data_contracts/" -type f -name "*.yaml" -exec sed -i 's/status: draft/status: verified/g' {} \;
          atlan push contract -f "data_contracts/"
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
