name: Data Contracts - Validate & Apply

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "What do you want to do?"
        required: true
        type: choice
        default: dry-run
        options:
          - dry-run
          - apply
      embed_certify:
        description: "Create/Update contracts as VERIFIED using embed-certify?"
        required: true
        type: choice
        default: "true"
        options:
          - "true"
          - "false"

jobs:
  validate:
    name: Dry-run validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Dry-run apply_data_contracts.py
        run: |
          EMBED_FLAG=""
          if [ "${{ github.event.inputs.embed_certify }}" = "true" ]; then
            EMBED_FLAG="--embed-certify"
          fi

          python scripts/apply_data_contracts.py \
            --dir contracts \
            --report dryrun_report.csv \
            --dry-run $EMBED_FLAG
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}

      - name: Upload dry-run report
        uses: actions/upload-artifact@v4
        with:
          name: dryrun-report
          path: dryrun_report.csv

  apply:
    name: Apply to Atlan (requires approval)
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.event.inputs.mode == 'apply' }}

    #  This environment will enforce manual approval in GitHub UI
    environment:
      name: atlan-prod
      url: https://accenture-partner.atlan.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Apply data contracts to Atlan
        run: |
          EMBED_FLAG=""
          if [ "${{ github.event.inputs.embed_certify }}" = "true" ]; then
            EMBED_FLAG="--embed-certify"
          fi

          python scripts/apply_data_contracts.py \
            --dir contracts \
            --report apply_report.csv \
            $EMBED_FLAG
        env:
          # Use environment-level secrets if you like, or repo-level
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}

      - name: Upload apply report
        uses: actions/upload-artifact@v4
        with:
          name: apply-report
          path: apply_report.csv
