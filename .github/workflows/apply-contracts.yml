name: Apply Atlan Data Contracts
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      certify:
        description: 'Set contracts to VERIFIED after apply'
        required: false
        default: 'false'
jobs:
  validate:
    name: Dry-run & validate (on push)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate env secrets present
        run: |
          if [ -z "${{ secrets.ATLAN_API_KEY }}" ]; then echo "Missing secret ATLAN_API_KEY" && exit 1; fi
          # ATLAN_BASE_URL optional if client handles it; otherwise ensure present
          if [ -z "${{ secrets.ATLAN_BASE_URL }}" ]; then echo "Missing secret ATLAN_BASE_URL" && exit 1; fi

      - name: Dry-run apply contracts
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}
        run: |
          python scripts/apply_data_contracts.py --dir contracts --report ./dryrun_report.csv --dry-run
          echo "Dry-run report:"
          cat ./dryrun_report.csv

  apply:
    name: Apply contracts to Atlan (manual trigger only)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Apply contracts (real)
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}
        run: |
          python scripts/apply_data_contracts.py --dir contracts --report ./apply_report.csv $([ "${{ github.event.inputs.certify }}" = "true" ] && echo "--certify")
          echo "Apply report:"
          cat ./apply_report.csv
          python scripts/apply_data_contracts.py --dir contracts --report ./apply_report.csv
          echo "Apply report:"
          cat ./apply_report.csv
