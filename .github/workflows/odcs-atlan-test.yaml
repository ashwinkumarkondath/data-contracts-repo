name: ODCS contracts using Atlan test CLI

on:
  workflow_run:
    workflows: ["Validation Workflow"]
    types:
      - completed

env:
  ATLAN_BINARY_URL: "https://github.com/atlanhq/atlan-cli-releases/releases/latest/download/atlan_Linux_amd64.tar.gz"
  BINARY_FILE_NAME: "atlan_Linux_amd64.tar.gz"

jobs:
  publish-contracts:
    # Only run when "Validation Workflow" completed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone/Fetch File from Repo
        uses: actions/checkout@v4
        with:
          repository: Flo891/dc_test 
          path: contracts                      
          token: ${{ secrets.REPO_READ_TOKEN }} 
            
      - name: Find YAML files in root
        id: find_yaml
        run: |
          files=$(find contracts -maxdepth 1 -type f \( -name "*.yaml" -o -name "*.yml" \))
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install converter dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Download atlan CLI
        run: |
          curl -LO "$ATLAN_BINARY_URL"

      - name: Uncompress CLI archive
        run: tar -xzf "$BINARY_FILE_NAME"

      - name: Install atlan CLI
        run: |
          sudo mv atlan /usr/local/bin/atlan
          chmod +x /usr/local/bin/atlan
          
      - name: Execute the script (ODCS → Atlan)
        run: |
          for file in ${{ steps.find_yaml.outputs.files }}; do
            echo "Processing $file"
            PYTHON_SCRIPT_INPUT_PATH="$file"
          python scripts/convert-odcs-atlan.py "$PYTHON_SCRIPT_INPUT_PATH"
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}   

      - name: Configure CLI with tenant URL and data source
        run: |
          mkdir -p .atlan
          cp config.yaml .atlan/
          echo "atlan_base_url: \"${ATLAN_BASE_URL}\"" >> .atlan/config.yaml
          echo "" >> .atlan/config.yaml
          cat .atlan/config.yaml
        env:
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}

      - name: Validate contracts (CLI)
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          # Run validation and capture output to a timestamped log file
          cat "$GITHUB_WORKSPACE/data_contracts/"*.yaml
          atlan validate contract -f "$GITHUB_WORKSPACE/data_contracts" 2>&1 | tee "validation_log_${TIMESTAMP}.txt"
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}

      - name: Upload validation log
        uses: actions/upload-artifact@v4
        with:
          name: validation-logs
          path: validation_log_*.txt 

      # ========== PER-FILE HASHING & CHANGE DETECTION ==========

      - name: Compute current contract hashes
        id: compute-hashes
        run: |
          set -e
          CONTRACT_DIR="$GITHUB_WORKSPACE/data_contracts"

          if [ ! -d "$CONTRACT_DIR" ]; then
            echo "Contract directory not found: $CONTRACT_DIR"
            exit 1
          fi

          # One line per file: "<hash>  <fullpath>"
          find "$CONTRACT_DIR" -type f -name '*.yaml' -print0 \
            | sort -z \
            | xargs -0 sha256sum > contracts_hashes.txt

          echo "Current contract hashes:"
          cat contracts_hashes.txt

      - name: Download previous contracts hashes artifact
        id: download-prev-hashes
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # IMPORTANT: workflow FILE name (in .github/workflows), not the display name
          workflow: odcs-atlan-test.yaml   # <--- change if your file name differs
          workflow_conclusion: success
          name: contracts-hashes
          path: previous-hash
          allow_forks: false
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Determine changed contract files
        id: diff-contracts
        run: |
          set -e
          CONTRACT_DIR="$GITHUB_WORKSPACE/data_contracts"
          CURRENT_HASHES="contracts_hashes.txt"
          PREV_HASHES="previous-hash/contracts_hashes.txt"

          if [ ! -f "$CURRENT_HASHES" ]; then
            echo "No current hashes file found."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If no previous hashes, treat ALL files as changed
          if [ ! -f "$PREV_HASHES" ]; then
            echo "No previous hashes found, treating all contracts as changed."
            awk '{print $2}' "$CURRENT_HASHES" > changed_files.txt
          else
            > changed_files.txt
            # Compare current vs previous hashes per full path
            while read -r curr_hash curr_path; do
              prev_hash=$(grep -F "  $curr_path" "$PREV_HASHES" | awk '{print $1}' || true)
              if [ "$prev_hash" != "$curr_hash" ]; then
                echo "$curr_path" >> changed_files.txt
              fi
            done < "$CURRENT_HASHES"
          fi

          if [ -s changed_files.txt ]; then
            echo "Changed contracts:"
            cat changed_files.txt
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "No contract changes detected."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      # ========== PUSH ONLY CHANGED CONTRACTS (DRAFT → VERIFIED) ==========

      - name: Push changed contracts (draft then verified)
        if: steps.diff-contracts.outputs.has_changes == 'true'
        run: |
          set -euo pipefail
          ATLAN_API_KEY="${ATLAN_API_KEY:?ATLAN_API_KEY not set}"

          echo "Changed contracts to process:"
          cat changed_files.txt

          while IFS= read -r full_path; do
            [ -z "$full_path" ] && continue

            echo "======================================="
            echo "Processing contract: $full_path"
            echo "======================================="

            if [ ! -f "$full_path" ]; then
              echo "WARNING: File not found, skipping: $full_path" >&2
              continue
            fi

            echo "Pushing DRAFT version..."
            atlan push contract -f "$full_path"

            echo "Switching status: draft -> verified in file (in-place)..."
            # Flip only a top-level 'status: draft' line
            sed -i 's/^status:[[:space:]]*draft[[:space:]]*$/status: verified/' "$full_path"

            echo "Pushing VERIFIED version..."
            atlan push contract -f "$full_path"

            echo "Reverting status: verified -> draft in file (restore original content)..."
            sed -i 's/^status:[[:space:]]*verified[[:space:]]*$/status: draft/' "$full_path"

          done < changed_files.txt
        env:
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}

      # ========== SAVE HASHES FOR NEXT RUN ==========

      - name: Upload contracts hashes artifact
        uses: actions/upload-artifact@v4
        with:
          name: contracts-hashes
          path: contracts_hashes.txt
